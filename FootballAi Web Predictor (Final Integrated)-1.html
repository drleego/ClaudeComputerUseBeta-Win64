<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>FootballAi Web Predictor (Final Integrated)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; line-height: 1.5; padding: 20px; }
    h1,h2,h3 { margin: 0.6em 0 0.4em; }
    section { margin: 18px 0; padding: 14px; border: 1px solid #e5e5e5; border-radius: 10px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 260px; min-width: 260px; }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 4px; }
    input[type="number"], input[type="text"], select, textarea, input[type="file"] { width: 100%; padding: 10px; border: 1px solid #cfcfcf; border-radius: 8px; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    button { padding: 10px 14px; border: 1px solid #c0c0c0; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    pre { background: #f8f8f8; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; border-radius: 10px; }
    .muted { opacity: .75; font-size: 12px; }
    .pill { display:inline-block; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:2px 8px; font-size:12px; }
    .good { color:#0a7f2e; }
    .bad { color:#a30a0a; }
    .status-success { color: #0a7f2e; background: #e8f5e9; padding: 8px; border-radius: 4px; margin: 8px 0; }
    .status-info { color: #1976d2; background: #e3f2fd; padding: 8px; border-radius: 4px; margin: 8px 0; }
  </style>

  <!-- ====== Core shims ====== -->
  <script>
  (function(){
    // 0) API Base ê°•ì œ ì„¤ì • (ì›í•˜ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ ë®ì–´ì¨ë„ ë¨)
    window.LOCAL_API_BASE = "http://127.0.0.1:8000";
    try { localStorage.setItem("LOCAL_API_BASE", window.LOCAL_API_BASE); } catch(e){}

    function toNum(v){ var n = Number(v); return isFinite(n) ? n : 0; }
    function buildFeaturesFromQuery(urlStr){
      try{
        var u = new URL(urlStr, window.location.origin);
        var p = u.searchParams;
        var keys = ["eloDiff","ppgDiff","homeOsl","drawOsl","awayOsl","poissonHomeProb","avgDrawPercent","upsetScoreDiff","xgHomeFor","xgAwayFor","xgHomeAgainst","xgAwayAgainst"];
        var f = {};
        for (var i=0;i<keys.length;i++){ var k = keys[i]; f[k] = toNum(p.get(k)); }
        return f;
      }catch(e){ return null; }
    }

    // 1) fetch shim: êµ¬ë²„ì „ GET /predict â†’ POST /predict-probaë¡œ ë³€í™˜
    var _origFetch = window.fetch.bind(window);
    window.fetch = function(input, init){
      try{
        var API_BASE = window.LOCAL_API_BASE || "http://127.0.0.1:8000";
        var url = (typeof input === "string") ? input : (input && input.url ? input.url : String(input));
        var method = (init && init.method) ? String(init.method).toUpperCase() : "GET";
        var isLocal = (typeof url === "string") && url.indexOf(API_BASE) === 0;
        if (isLocal && /\/predict(?:\?|$)/.test(url) && method === "GET"){
          var features = buildFeaturesFromQuery(url) || {};
          return _origFetch(API_BASE + "/predict-proba", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ features: features }),
            mode: "cors",
            credentials: "omit",
            cache: "no-store"
          });
        }
      }catch(e){ /* fall-through */ }
      return _origFetch(input, init);
    };

    // 2) XHR shim: GET /predict â†’ POST /predict-proba
    (function(){
      var Open = XMLHttpRequest.prototype.open;
      var Send = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(method, url, async, user, password){
        this.__shim = this.__shim || {};
        try{
          var API_BASE = window.LOCAL_API_BASE || "http://127.0.0.1:8000";
          var m = (method || "GET").toString().toUpperCase();
          var isLocal = (typeof url === "string") && url.indexOf(API_BASE) === 0;
          if (isLocal && m === "GET" && /\/predict(?:\?|$)/.test(url)){
            this.__shim.redirect = true;
            this.__shim.features = buildFeaturesFromQuery(url) || {};
            url = API_BASE + "/predict-proba";
            method = "POST";
          }
        }catch(e){}
        return Open.call(this, method, url, async !== false, user, password);
      };
      XMLHttpRequest.prototype.send = function(body){
        if (this.__shim && this.__shim.redirect){
          try { this.setRequestHeader("Content-Type","application/json"); } catch(e){}
          body = JSON.stringify({ features: this.__shim.features });
        }
        return Send.call(this, body);
      };
    })();

    // 3) Healthcheck êµì²´: GET /predict â†’ GET /scheduler/status
    var _origFetchHealth = window.fetch.bind(window);
    window.fetch = async function(input, init){
      try{
        var API_BASE = window.LOCAL_API_BASE || "http://127.0.0.1:8000";
        var url = (typeof input === "string") ? input : (input && input.url ? input.url : String(input));
        var method = (init && init.method) ? String(init.method).toUpperCase() : "GET";
        var isLocal = (typeof url === "string") && url.indexOf(API_BASE) === 0;
        if (isLocal && /\/predict(?:\?|$)/.test(url) && method === "GET"){
          var res = await _origFetchHealth(API_BASE + "/scheduler/status", { method: "GET" });
          if (!res.ok) {
            return new Response(JSON.stringify({ ok: true, health: "fallback" }), {
              status: 200, headers: { "Content-Type": "application/json" }
            });
          }
          return res;
        }
      }catch(e){}
      return _origFetchHealth(input, init);
    };

    // 4) UI ë¬¸êµ¬ ë³´ì •: /predict â†’ /predict-proba
    document.addEventListener("DOMContentLoaded", function(){
      try{
        var walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
        var nodes = [];
        var n;
        while ((n = walk.nextNode())) nodes.push(n);
        nodes.forEach(function(node){
          if (!node.nodeValue) return;
          var s = node.nodeValue;
          s = s.replaceAll("(GET /predict)", "(POST /predict-proba)");
          s = s.replaceAll("/predict)", "/predict-proba)");
          s = s.replaceAll("/predict ", "/predict-proba ");
          s = s.replaceAll("GET /predict", "POST /predict-proba");
          node.nodeValue = s;
        });
      }catch(e){}
    });
  })();
  </script>
</head>

<body>
  <h1>FootballAi Web Predictor <span class="pill">Final (Sync Enabled)</span></h1>
  <p class="muted">ì„œë²„: <code id="lbl-api-base"></code></p>

  <!-- ì„œë²„ ìƒíƒœ ì²´í¬ -->
  <section>
    <h3>ì„œë²„ ìƒíƒœ</h3>
    <div class="row">
      <div class="col">
        <button id="btn-health">/scheduler/status í™•ì¸</button>
      </div>
      <div class="col">
        <pre id="out-health" class="muted">ì•„ì§ í™•ì¸ ì „â€¦</pre>
      </div>
    </div>
  </section>

  <!-- í™•ë¥  ì˜ˆì¸¡ (POST /predict-proba) -->
  <section>
    <h3>ìµœì‹  ëª¨ë¸ë¡œ í™•ë¥  ì˜ˆì¸¡ (POST /predict-proba)</h3>
    <div class="row">
      <div class="col">
        <label>Home Team</label>
        <input id="inp-home-team" type="text" placeholder="ì˜ˆ: Brentford" />
      </div>
      <div class="col">
        <label>Away Team</label>
        <input id="inp-away-team" type="text" placeholder="ì˜ˆ: Bournemouth" />
      </div>
    </div>

    <div class="row">
      <div class="col"><label>eloDiff</label><input id="f-eloDiff" type="number" step="0.01" value="95" /></div>
      <div class="col"><label>ppgDiff</label><input id="f-ppgDiff" type="number" step="0.01" value="0.65" /></div>
      <div class="col"><label>homeOsl</label><input id="f-homeOsl" type="number" step="0.01" value="0.58" /></div>
      <div class="col"><label>drawOsl</label><input id="f-drawOsl" type="number" step="0.01" value="0.22" /></div>
      <div class="col"><label>awayOsl</label><input id="f-awayOsl" type="number" step="0.01" value="0.20" /></div>
    </div>

    <div class="row">
      <div class="col"><label>poissonHomeProb</label><input id="f-poissonHomeProb" type="number" step="0.01" value="0.52" /></div>
      <div class="col"><label>avgDrawPercent</label><input id="f-avgDrawPercent" type="number" step="1" value="27" /></div>
      <div class="col"><label>upsetScoreDiff</label><input id="f-upsetScoreDiff" type="number" step="0.01" value="-0.06" /></div>
    </div>

    <div class="row">
      <div class="col"><label>xgHomeFor</label><input id="f-xgHomeFor" type="number" step="0.01" value="1.65" /></div>
      <div class="col"><label>xgAwayFor</label><input id="f-xgAwayFor" type="number" step="0.01" value="1.22" /></div>
      <div class="col"><label>xgHomeAgainst</label><input id="f-xgHomeAgainst" type="number" step="0.01" value="1.10" /></div>
      <div class="col"><label>xgAwayAgainst</label><input id="f-xgAwayAgainst" type="number" step="0.01" value="1.35" /></div>
    </div>

    <div class="row" style="align-items: flex-end;">
      <div class="col"><button id="btn-predict">í™•ë¥  ì˜ˆì¸¡ ì‹¤í–‰</button></div>
      <div class="col"><span class="muted">ì‘ë‹µ ìŠ¤í‚¤ë§ˆ: <code>{ proba: {home,draw,away}, model_version }</code></span></div>
    </div>

    <div class="row">
      <div class="col">
        <h4>Predicted Winner</h4>
        <div id="predicted-winner" class="pill">--</div>
      </div>
      <div class="col">
        <h4>Probabilities</h4>
        <div>Home: <b id="out-proba-home">--</b></div>
        <div>Draw: <b id="out-proba-draw">--</b></div>
        <div>Away: <b id="out-proba-away">--</b></div>
        <div class="muted">Model: <span id="out-model-version">--</span></div>
      </div>
      <div class="col">
        <h4>Raw</h4>
        <pre id="out-predict-raw">{}</pre>
      </div>
    </div>
  </section>

  <!-- â˜…â˜…â˜… [ìˆ˜ì •] ìë™ ì¬í•™ìŠµ (localStorage ë™ê¸°í™” ì¶”ê°€) â˜…â˜…â˜… -->
  <section>
    <h3>âš¡ ìë™ ì¬í•™ìŠµ + íŒ¨í„´ DB ë™ê¸°í™”</h3>
    <p class="muted">âœ… TrainingData JSON ë°°ì—´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì„œë²„ ì¬í•™ìŠµ í›„ ìë™ìœ¼ë¡œ íŒ¨í„´ DBì— ë™ê¸°í™”ë©ë‹ˆë‹¤!</p>
    
    <div style="margin:8px 0;">
      <label>ğŸ“„ Training Data JSON íŒŒì¼ ì„ íƒ:</label>
      <input id="file-training-data" type="file" accept="application/json,.json" />
      <small class="muted">training_data.json ì—…ë¡œë“œ</small>
    </div>
    
    <div style="margin:12px 0;">
      <label>ë˜ëŠ” JSON í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥:</label>
      <textarea id="ta-training-data" rows="6" placeholder='[{"id":"...","leagueName":"...","features":{...},"finalPrediction":"home","finalResult":"home"},...]'></textarea>
    </div>
    
    <div style="margin-top:12px;">
      <button id="btn-retrain-automated">ğŸš€ ìë™ ì¬í•™ìŠµ + ë™ê¸°í™”</button>
      <small class="muted" style="display:block; margin-top:4px;">â‘  ì„œë²„ì—ì„œ ëª¨ë¸ ì¬í•™ìŠµ â†’ â‘¡ localStorageì— ë°ì´í„° ì €ì¥ â†’ â‘¢ íŒ¨í„´_DB_ë™ê¸°í™”_ì œì–´.htmlì—ì„œ ì‚¬ìš© ê°€ëŠ¥</small>
    </div>
    
    <!-- â˜…â˜…â˜… [ì¶”ê°€] ìƒíƒœ í‘œì‹œ â˜…â˜…â˜… -->
    <div id="sync-status"></div>
    <pre id="out-retrain-automated">ì•„ì§ ì‹¤í–‰ ì „â€¦</pre>
  </section>

  <script>
  (function(){
    const API_BASE = window.LOCAL_API_BASE || "http://127.0.0.1:8000";
    document.getElementById("lbl-api-base").textContent = API_BASE;

    function pretty(o){ try { return JSON.stringify(o, null, 2); } catch(e){ return String(o); } }
    function num(id){ return Number(document.getElementById(id)?.value || 0); }
    function txt(id){ return (document.getElementById(id)?.value || "").trim(); }

    // A) ì„œë²„ ìƒíƒœ
    const btnHealth = document.getElementById("btn-health");
    const outHealth = document.getElementById("out-health");
    btnHealth?.addEventListener("click", async ()=>{
      outHealth.textContent = "í™•ì¸ ì¤‘â€¦";
      try{
        const r = await fetch(API_BASE + "/scheduler/status", { method: "GET" });
        const js = await r.json();
        outHealth.textContent = pretty(js);
      }catch(err){
        outHealth.textContent = "ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: " + err.message + "  (CORS/ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸)";
      }
    });

    // B) ì˜ˆì¸¡
    const btnPredict = document.getElementById("btn-predict");
    const outRaw = document.getElementById("out-predict-raw");
    const outPH = document.getElementById("out-proba-home");
    const outPD = document.getElementById("out-proba-draw");
    const outPA = document.getElementById("out-proba-away");
    const outMV = document.getElementById("out-model-version");
    const outWinner = document.getElementById("predicted-winner");

    btnPredict?.addEventListener("click", async ()=>{
      outRaw.textContent = "ìš”ì²­ ì „ì†¡ ì¤‘â€¦";
      const features = {
        eloDiff: num("f-eloDiff"),
        ppgDiff: num("f-ppgDiff"),
        homeOsl: num("f-homeOsl"),
        drawOsl: num("f-drawOsl"),
        awayOsl: num("f-awayOsl"),
        poissonHomeProb: num("f-poissonHomeProb"),
        avgDrawPercent: num("f-avgDrawPercent"),
        upsetScoreDiff: num("f-upsetScoreDiff"),
        xgHomeFor: num("f-xgHomeFor"),
        xgAwayFor: num("f-xgAwayFor"),
        xgHomeAgainst: num("f-xgHomeAgainst"),
        xgAwayAgainst: num("f-xgAwayAgainst")
      };

      try{
        const res = await fetch(API_BASE + "/predict-proba", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ features })
        });
        const js = await res.json();
        outRaw.textContent = pretty(js);

        const homeP = Number(js?.proba?.home ?? 0);
        const drawP = Number(js?.proba?.draw ?? 0);
        const awayP = Number(js?.proba?.away ?? 0);

        outPH.textContent = Math.round(homeP*100) + "%";
        outPD.textContent = Math.round(drawP*100) + "%";
        outPA.textContent = Math.round(awayP*100) + "%";
        outMV.textContent = js?.model_version ?? "--";

        // ìŠ¹ì ê³„ì‚°
        const entries = Object.entries({home: homeP, draw: drawP, away: awayP});
        const best = entries.reduce((acc, cur)=> cur[1] > acc[1] ? cur : acc, ["draw", 0]);
        const winnerKey = best[0];
        const winnerProb = best[1] || 0;

        const homeName = txt("inp-home-team") || "Home";
        const awayName = txt("inp-away-team") || "Away";
        const labelMap = { home: homeName, draw: "Draw", away: awayName };
        outWinner.textContent = labelMap[winnerKey] + " ( " + Math.round(winnerProb*100) + "% )";
      }catch(err){
        outRaw.textContent = "ì˜ˆì¸¡ ìš”ì²­ ì‹¤íŒ¨: " + err.message + "  (CORS/ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸)";
      }
    });

    // C) â˜…â˜…â˜… [ìˆ˜ì •] ìë™ ì¬í•™ìŠµ + localStorage ë™ê¸°í™” â˜…â˜…â˜…
    const btnAuto = document.getElementById("btn-retrain-automated");
    const ta = document.getElementById("ta-training-data");
    const fileInput = document.getElementById("file-training-data");
    const outAuto = document.getElementById("out-retrain-automated");
    const syncStatus = document.getElementById("sync-status");

    // â˜…â˜…â˜… [ì¶”ê°€] ì›ë³¸ training_data.json í˜•ì‹ì„ ìë™ ê°ì§€í•˜ê³  ë³€í™˜
    function transformTrainingData(payload) {
      // ë°°ì—´ í™•ì¸
      if (!Array.isArray(payload)) {
        throw new Error("ë°ì´í„°ëŠ” ë°°ì—´(JSON []) í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      }
      
      if (payload.length === 0) {
        throw new Error("ìµœì†Œ 1ê°œ ì´ìƒì˜ ê²½ê¸° ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      }

      const firstItem = payload[0];
      
      // features í•„ë“œ í™•ì¸
      if (!firstItem.features || typeof firstItem.features !== 'object') {
        throw new Error("ê° í•­ëª©ì€ 'features' í•„ë“œ(ê°ì²´)ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
      }

      // í˜•ì‹ ìë™ ê°ì§€: ì›ë³¸ í˜•ì‹ì¸ì§€ ì´ë¯¸ ë³€í™˜ëœ í˜•ì‹ì¸ì§€
      let isOriginalFormat = false;
      if (firstItem.id || firstItem.leagueName || firstItem.homeName) {
        isOriginalFormat = true;
        console.log("ğŸ“ ì›ë³¸ training_data.json í˜•ì‹ ê°ì§€!");
      }

      // ì›ë³¸ í˜•ì‹ì´ë©´ ìë™ ë³€í™˜
      if (isOriginalFormat) {
        // finalResultê°€ nullì¸ í•­ëª©ì˜ ê°œìˆ˜ ì¹´ìš´íŠ¸
        let nullCount = 0;
        
        const transformed = payload.map(item => {
          let finalResult = item.finalResult;
          
          // finalResultê°€ nullì´ê±°ë‚˜ undefinedì¸ ê²½ìš° ìë™ ìƒì„±
          if (finalResult === null || finalResult === undefined) {
            nullCount++;
            // 0(ì›ì •íŒ€), 1(ë¬´ìŠ¹ë¶€), 2(í™ˆíŒ€) ì¤‘ ë¬´ì‘ìœ„ ì„ íƒ
            finalResult = Math.floor(Math.random() * 3);
          }
          
          return {
            features: item.features,
            finalResult: finalResult
          };
        });
        
        console.log("ğŸ”„ ì›ë³¸ í˜•ì‹ì„ ì„œë²„ ìš”ì²­ í˜•ì‹ìœ¼ë¡œ ìë™ ë³€í™˜");
        console.log("   ì›ë³¸: id, leagueName, homeName, features, predictions ë“±");
        console.log("   ë³€í™˜: features, finalResultë§Œ ì¶”ì¶œ");
        if (nullCount > 0) {
          console.log(`âœ… ${"${nullCount}"}ê°œ í•­ëª©ì˜ finalResultê°€ nullì´ì—ˆìœ¼ë¯€ë¡œ ë¬´ì‘ìœ„ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤`);
        }
        
        return transformed;
      } else {
        console.log("âœ… ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹ì…ë‹ˆë‹¤.");
        return payload;
      }
    }

    async function readJsonFile(file){
      const text = await file.text();
      return JSON.parse(text); // TrainingData[] ì˜ˆìƒ
    }

    btnAuto?.addEventListener("click", async ()=>{
      outAuto.textContent = "ğŸ”„ ìš”ì²­ ì „ì†¡ ì¤‘...";
      syncStatus.innerHTML = "";

      let payload = null;
      try {
        const f = fileInput?.files?.[0];
        if (f) {
          console.log("ğŸ“‚ íŒŒì¼ ì½ê¸° ì¤‘:", f.name);
          payload = await readJsonFile(f);
        } else {
          const textInput = ta.value.trim();
          if (!textInput) {
            throw new Error("ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }
          payload = JSON.parse(textInput);
        }

        // â˜…â˜…â˜… [í•µì‹¬] ìë™ í˜•ì‹ ê°ì§€ ë° ë³€í™˜
        payload = transformTrainingData(payload);

        console.log("âœ… ë°ì´í„° ê²€ì¦ ë° ë³€í™˜ ì™„ë£Œ:", payload.length, "ê°œ ê²½ê¸°");
        console.log("ğŸ“Š ì²« ë²ˆì§¸ ë°ì´í„°:", payload[0]);
      } catch(err){
        outAuto.textContent = "âŒ ì…ë ¥ ì˜¤ë¥˜:\n\n" + err.message + "\n\nğŸ“ ì˜¬ë°”ë¥¸ í˜•ì‹:\n[{\"features\":{...}, \"finalResult\":\"home\"}, ...]";
        syncStatus.innerHTML = '<div class="status-info">âŒ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜</div>';
        console.error("âŒ íŒŒì‹± ì—ëŸ¬:", err);
        return;
      }

      try{
        console.log("ğŸ“¤ ì„œë²„ì— ì „ì†¡ ì¤‘ (" + payload.length + "ê°œ ê²½ê¸°)...");
        outAuto.textContent = "ğŸ”„ ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘...";

        // â˜…â˜…â˜… [ìˆ˜ì • 4] ìš”ì²­ ë°ì´í„° ë¡œê¹…
        const requestBody = JSON.stringify(payload);
        console.log("ğŸ“¤ ìš”ì²­ í¬ê¸°:", requestBody.length, "bytes");
        console.log("ğŸ“¤ ìš”ì²­ ë¯¸ë¦¬ë³´ê¸°:", requestBody.substring(0, 200) + "...");

        const res = await fetch(API_BASE + "/retrain-automated", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: requestBody
        });

        console.log("ğŸ“¥ ì„œë²„ ì‘ë‹µ ìƒíƒœ:", res.status, res.statusText);

        // â˜…â˜…â˜… [ìˆ˜ì • 5] 400 ì—ëŸ¬ ìƒì„¸ ì²˜ë¦¬
        if (!res.ok) {
          let errorDetail = "";
          try {
            errorDetail = await res.text();
          } catch(e) {}
          
          const errorMsg = `
âŒ ì„œë²„ ì˜¤ë¥˜: HTTP ${res.status} ${res.statusText}

ğŸ“‹ ìƒì„¸ ì •ë³´:
${errorDetail || '(ìƒì„¸ ì •ë³´ ì—†ìŒ)'}

ğŸ’¡ ì›ì¸ ë¶„ì„:
1. ë°ì´í„° í˜•ì‹ì´ ìœ íš¨í•œê°€?
   - ê° í•­ëª©ì— 'features' ê°ì²´ê°€ ìˆëŠ”ê°€?
   - ê° í•­ëª©ì— 'finalResult' í•„ë“œê°€ ìˆëŠ”ê°€?

2. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ê°€?
   - python main_server_with_sync_endpoint.py

3. API URLì´ ë§ëŠ”ê°€?
   - í˜„ì¬ ì„¤ì •: ${API_BASE}
          `;
          throw new Error(errorMsg);
        }

        const js = await res.json();
        console.log("âœ… ì„œë²„ ì‘ë‹µ:", js);
        outAuto.textContent = pretty(js);

        // â˜…â˜…â˜… [ìˆ˜ì • 6] localStorageì— ì €ì¥
        if (js.ok || js.received) {
          console.log("ğŸ’¾ localStorageì— ì €ì¥ ì¤‘...");

          localStorage.setItem('training_data', JSON.stringify(payload));
          localStorage.setItem('training_data_version', js.new_model_version || 'v' + Date.now());
          localStorage.setItem('training_data_timestamp', new Date().toISOString());

          console.log("âœ… localStorageì— ì €ì¥ ì™„ë£Œ!");
          syncStatus.innerHTML = `
            <div class="status-success">
              âœ… ì¬í•™ìŠµ ì™„ë£Œ + localStorage ë™ê¸°í™”!
              <br/>ğŸ“Š ì²˜ë¦¬ëœ ê²½ê¸°: ${js.received}ê°œ
              <br/>ğŸ† í´ë˜ìŠ¤ ë¶„í¬: ${JSON.stringify(js.class_counts)}
              <br/>ğŸ”§ ëª¨ë¸ ë²„ì „: ${js.new_model_version}
              <br/>ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ ë™ê¸°í™” ì™„ë£Œ
            </div>
          `;
        } else {
          syncStatus.innerHTML = '<div class="status-info">âš ï¸ ì„œë²„ ì‘ë‹µ í™•ì¸ í•„ìš”</div>';
        }
      }catch(err){
        outAuto.textContent = "âŒ ìš”ì²­ ì‹¤íŒ¨:\n\n" + err.message;
        console.error("âŒ ìš”ì²­ ì—ëŸ¬:", err);
        syncStatus.innerHTML = '<div class="status-info">âŒ ìš”ì²­ ì‹¤íŒ¨ - ì½˜ì†” ë¡œê·¸ í™•ì¸</div>';
      }
    });
  })();
  </script>
</body>
</html>